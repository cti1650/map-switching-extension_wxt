name: Release Extension

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pull-requests: write

jobs:
  ci:
    uses: ./.github/workflows/test.yml

  release:
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # バージョンチェック&更新(分離したアクション)
      - name: Check and update version
        id: version
        uses: ./.github/workflows/actions/check-version
        with:
          tag: ${{ github.ref_name }}
          update_package_json: "true"

      # --- ここでビルド処理(更新されたバージョンで) ---
      - name: Setup Action
        uses: ./.github/workflows/actions/setup

      - name: Build Chrome extension
        run: yarn build

      - name: Zip extensions
        run: yarn zip

      # PRを作成(バージョンが変更された場合のみ)
      - name: Create Pull Request
        if: steps.version.outputs.needs_bump == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: release/v${{ steps.version.outputs.tag_version }}
          commit-message: "chore: bump version to ${{ steps.version.outputs.tag_version }}"
          title: "Release v${{ steps.version.outputs.tag_version }}"
          body: |
            タグ **v${{ steps.version.outputs.tag_version }}** に基づく自動生成PRです。

            - Current version: `${{ steps.version.outputs.current_version }}`
            - New version: `${{ steps.version.outputs.tag_version }}`
          base: master

      - name: Submit to stores
        run: |
          yarn wxt submit --dry-run \
            --chrome-zip .output/*-chrome.zip
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: .output/**/*.zip

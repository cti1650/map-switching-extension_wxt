name: Release Extension

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pull-requests: write

jobs:
  ci:
    uses: ./.github/workflows/test.yml

  release:
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Action
        uses: ./.github/workflows/actions/setup

      # 現在の package.json の version を取得
      - name: Read current version
        id: current
        run: |
          CURRENT=$(jq -r '.version' package.json)
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

      # タグから version を抽出
      - name: Extract version from tag
        id: tag
        run: |
          TAG=${GITHUB_REF##*/}
          VERSION=${TAG#v}
          echo "tag_version=$VERSION" >> $GITHUB_OUTPUT

      # version が違う場合だけ package.json を更新
      - name: Update version if needed
        id: update
        run: |
          if [ "${{ steps.current.outputs.current }}" = "${{ steps.tag.outputs.tag_version }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "changed=true" >> $GITHUB_OUTPUT
          VERSION="${{ steps.tag.outputs.tag_version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json

      # versionが変わった場合のみ PR 作成
      - name: Commit version bump
        if: steps.update.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.tag.outputs.tag_version }}"
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -b release/v$VERSION
          git add package.json
          git commit -m "chore: bump version to $VERSION"
          git push origin HEAD

      - name: Create Pull Request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: release/v${{ steps.tag.outputs.tag_version }}
          title: "Release v${{ steps.tag.outputs.tag_version }}"
          body: |
            タグ **v${{ steps.tag.outputs.tag_version }}** に基づく自動生成PRです。
          base: master

      # --- ここから publish 処理（常に実行） ---
      - name: Zip extensions
        run: |
          yarn zip
          # yarn zip:firefox

      - name: Submit to stores
        run: |
          yarn wxt submit \
            --chrome-zip .output/*-chrome.zip \
            # --firefox-zip .output/*-firefox.zip \
            # --firefox-sources-zip .output/*-sources.zip
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

      # GitHub Release はタグ単位で常に作成
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
